<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Chat App</title>
	<link rel="stylesheet" href="/static/chat.css">
</head>
<body>
    <script>
		
        snapshot = localStorage.getItem("current")

    </script>
	<style>
		my-name, ai-name, model-id A{
			display:inline;
			font-weight:bold
		}
	</style>
	<div class="chat-list">
		<ul>
			<!-- The user's sessions AKA the model's instances -->
		</ul>
		
		<!-- Floating action button bottom left, pops dialog-->
		<div id="mybutton">
			<button class="spawn"><i class="fa fa-plus" aria-hidden="true"></i>
				Spawn New</button>
		</div>
	</div>
	<div class="chat-window">
		<div class="intro-state">
			<p>System Message: your new sentient being has been spawned from model <model-id></model-id>. Now chatting with <ai-name></ai-name>
			as <my-name></my-name>. Say something or ask a question. Please be aware that 
			your bot is a unique individual and will grow and develop its personality over time
			so it is important to converse with your bot frequently about a variety of topics
			</p>
		</div>


		<div class="chat-messages">

		</div>
		<div class="text-entry">
			<textarea id="query-box" placeholder="Type your message..."></textarea>
		</div>
	</div>

	<!-- This div contains a serialized user object rendered at the server in main.py -->
	<!-- Its contents should be JSON.parsed and used as the state_dick for this screen -->
	<div style="display:none" id="injected_js">
	{{user.user_id}}
	</div>    
    <script src="https://code.jquery.com/jquery-3.6.3.js"></script>
    <!-- Session state and login JS-->
    <script src="/static/core.js"></script>
    <script>
	//was supposed to be state_dicT but decided to leave as is
	//because everytime i see "state dick" i think "donald j. trump"
	//and now you will too...


    window.state_dick = {}
	window.model_zoo = []
	const getModels = (cb) => {
		$.get("/models", (model_ids) => {
			model_ids.forEach(async(m) => {
				var fullmodel = await fetch("/models/"+m)
				model_zoo.push(fullmodel)
				if (typeof cb ==="function")
					cb(window_model_zoo)
			})
		})
	}

    const populateSessions = () => {
        var sessions = window.state_dick.user.active_sessions
		window.state_dick.active_session=sessions[0].SESSION_ID

        sessions.forEach(session => { 
			session_li_template = `
        	<li onclick="javascript:populateMessages('${session.SESSION_ID}');return false">
				<span class="icon"><img class="avatar_sm" src="/static/synthia.png" /></span>
				<span class="title">${session.ai_name}</span>
				<span class="time">${session.conversation && session.conversation.length > 0 ? session.conversation.length+" Messages" : "New Conversation"}</span>
			</li>`
			$(".chat-list ul").append(session_li_template)
        });
    }

	const populateMessages = (sessionId) =>{
		var sessions = window.state_dick.user.active_sessions
		var session = sessions.filter(x => x.SESSION_ID == sessionId)[0]
		window.state_dick.active_session = sessionId
		$(".chat-messages").html("")
		session.conversation.forEach(messagePair => {
			//Note: this needs to be refactored ASAP at the server...
			//the couplet pattern predicated on a mention of the sender within a string
			//is brittle as hell... yes its what the bot understands
			//but its exactly the opposite of a data structure you can work with
			var couplet=messagePair.split(session.ai_name+": ")
			couplet[0] = couplet[0].replace(session.user_name+": ", "")
			couplet[1] = couplet[1].replace(session.ai_name+": ", "")

			var synthiaAvatar="/static/synthia.png"

			var query= `<div class="message sent">
									<span class="avatar"><img
					src="https://api.dicebear.com/5.x/shapes/svg?seed=${session.user_name}"
					alt="avatar"
					/>
					</span>
				<span class="text"><sent-by>${session.user_name}</sent-by><br />${couplet[0]}</span>
			</div>
			`
			var reply=`<div class="message">
				<span class="avatar"><img src="${synthiaAvatar}" /></span>
				<span class="text"><sent-by>${session.ai_name}</sent-by><br />${couplet[1]}</span>
			</div>
			`

			var rendered_pair = query+reply
			$(".chat-messages").append(rendered_pair)
		})
	}
    $(document).ready(function () {
        //we need to enforceLogin() ASAP
		$.get("/users/"+$("#injected_js").text(), (u) =>{ 
			window.state_dick={user:u}
			populateSessions()
			populateMessages(window.state_dick.user.active_sessions[0].SESSION_ID)
		})
		document.addEventListener("keyup", function(event) {
		if (event.keyCode === 13) {
				//Step one: send your message to the bot
				var active = state_dick.active_session
				var sessions = window.state_dick.user.active_sessions
				var session = sessions.filter(x => x.SESSION_ID == active)[0]
				var q = $("#query-box").val()
				$("#query-box").attr("disabled", "disabled")
				var sent_message= `<div class="message sent">
									<span class="avatar"><img
						src="https://api.dicebear.com/5.x/shapes/svg?seed=${session.user_name}"
						alt="avatar"
						/>
						</span>
					<span class="text"><sent-by>${session.user_name}</sent-by><br />${q}</span>
				</div>
			`
				$(".chat-messages").append(sent_message)
				var chatmsgref = $(".chat-messages")
				$.get("/sessions/"+active+"/query/"+encodeURIComponent(q), (response) =>{
					//Step two: display result
					var received_message=`<div class="message">
						<span class="avatar"><img src="/static/synthia.png" /></span>
						<span class="text"><sent-by>${session.ai_name}</sent-by><br />${response.response}</span>
					</div>
					`


					$(".chat-messages").append(received_message)

					//Step three: rinse and repeat - re-enable query box
					$("#query-box").removeAttr("disabled")
					
					//Step four: TODO - update state dick (but it shouldn't really matter because the DOM is holding the state)

				})
			
			}
		});

		/* No need to call this, because we included the JSON in the initial page load 
        refreshCurrentUser((user) => 
        {
            window.state_dick.user = user;
            populateSessions()
            //populateMessages()    
        })*/
    })
    </script>


</body>
</html>
